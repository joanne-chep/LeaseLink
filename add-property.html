<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeaseLink - Add New Property</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/utils.css">
    <style>
        .form-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="url"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        .form-group select {
            appearance: none; 
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-5.4H18.6c-5%200-9.3%201.8-12.9%205.4-3.6%203.6-5.4%207.9-5.4%2013.2%200%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.9%205.4%2013.2%205.4s9.6-1.8%2013.2-5.4l128-127.9c3.6-3.6%205.4-7.8%205.4-12.9%200-5.3-1.8-9.6-5.4-13.2z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px;
        }
        .btn-submit {
            background-color: #8B4513; 
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
        }
        .btn-submit:hover {
            background-color: #A0522D; 
        }
        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .image-preview-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .image-preview-item img {
            max-width: 80px;
            max-height: 80px;
            margin-right: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            object-fit: cover;
        }
        .image-description-input {
            flex-grow: 1;
            margin-right: 15px;
        }
        .remove-image-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .remove-image-btn:hover {
            background-color: #c82333;
        }
    </style>
    <script src="js/authGuard.js"></script>
    <script src="js/logout.js"></script>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="logo">LeaseLink</div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="properties.html">Properties</a></li>
                <li><a href="login.html" id="navAuthLink">Login</a></li>
            </ul>
        </nav>
    </header>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentUserId = null; 
        const navAuthLink = document.getElementById('navAuthLink');
        const navLinksUl = navAuthLink ? navAuthLink.parentNode.parentNode : null;
        const loginListItem = navAuthLink ? navAuthLink.parentNode : null;

        // --- FETCH SESSION DATA FOR AUTH & USER ID
        fetch('backend/get_session_info.php')
            .then(response => response.json())
            .then(data => {
                const { userName, userType, isLoggedIn, userId } = data;
                
                if (!isLoggedIn || userType !== 'landlord') {
                    // If not logged in or not a landlord, redirect to login
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUserId = userId; 

                // --- Navigation Update (Same as previous step)
                if (navAuthLink && navLinksUl && loginListItem) {
                    const dashboardLink = document.createElement('a');
                    dashboardLink.textContent = `Welcome, ${userName}`;
                    let dashboardUrl = (userType === 'client') ? 'client-dashboard.html' : 
                                        (userType === 'landlord') ? 'landlord-dashboard.html' : 
                                        (userType === 'admin') ? 'admin-dashboard.html' : 'index.html';
                    dashboardLink.href = dashboardUrl;
                    const dashboardListItem = document.createElement('li');
                    dashboardListItem.appendChild(dashboardLink);

                    const logoutLink = document.createElement('a');
                    logoutLink.href = '#';
                    logoutLink.textContent = 'Logout';
                    logoutLink.onclick = (e) => {
                        e.preventDefault();
                        performLogout();
                    };
                    const logoutListItem = document.createElement('li');
                    logoutListItem.appendChild(logoutLink);

                    navLinksUl.replaceChild(dashboardListItem, loginListItem);
                    navLinksUl.appendChild(logoutListItem);

                    if (userType === 'landlord' || userType === 'admin') {
                        navLinksUl.querySelectorAll('a').forEach(link => {
                            if (link.getAttribute('href') === 'index.html' || link.getAttribute('href') === 'properties.html') {
                                if (link.parentElement.tagName === 'LI') { link.parentElement.style.display = 'none'; }
                            }
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching session info:', error);
                window.location.href = 'login.html';
                return;
            });


            // Handle form submission and image previews/descriptions
            const addPropertyForm = document.getElementById('addPropertyForm');
            const messageDiv = document.getElementById('message');
            const propertyImagesInput = document.getElementById('propertyImages');
            const imageDescriptionInputsDiv = document.getElementById('imageDescriptionInputs');

            let selectedFiles = new Map(); 
            let fileCounter = 0;

            function renderImagePreviews() {
                imageDescriptionInputsDiv.innerHTML = '';
                let index = 0;
                selectedFiles.forEach((file, fileId) => {
                    const fileReader = new FileReader();
                    fileReader.onload = (e) => {
                        const imgContainer = document.createElement('div');
                        imgContainer.classList.add('image-preview-item');
                        imgContainer.dataset.fileId = fileId; 

                        const imgPreview = document.createElement('img');
                        imgPreview.src = e.target.result;
                        imgPreview.alt = file.name;
                        imgContainer.appendChild(imgPreview);

                        const descriptionInput = document.createElement('input');
                        descriptionInput.type = 'text';
                        descriptionInput.placeholder = `Description for ${file.name}`;
                        descriptionInput.name = `image_descriptions[${fileId}]`;
                        descriptionInput.classList.add('image-description-input');
                        descriptionInput.value = file.description || ''; 
                        imgContainer.appendChild(descriptionInput);

                        const removeButton = document.createElement('button');
                        removeButton.type = 'button';
                        removeButton.classList.add('remove-image-btn');
                        removeButton.textContent = 'X';
                        removeButton.addEventListener('click', () => {
                            selectedFiles.delete(fileId); 
                            renderImagePreviews(); 
                            if (selectedFiles.size === 0) {
                                propertyImagesInput.value = '';
                            }
                        });
                        imgContainer.appendChild(removeButton);

                        imageDescriptionInputsDiv.appendChild(imgContainer);
                    };
                    fileReader.readAsDataURL(file);
                    index++;
                });
            }

            // Event listener for image file selection (no change)
            propertyImagesInput.addEventListener('change', (event) => {
                Array.from(event.target.files).forEach(file => {
                    const fileId = `file_${fileCounter++}`;
                    selectedFiles.set(fileId, file);
                });
                renderImagePreviews();
            });

            // Event listener for form submission
            addPropertyForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                messageDiv.textContent = '';
                messageDiv.className = 'message'; 

                if (!currentUserId) {
                    messageDiv.classList.add('error');
                    messageDiv.textContent = 'Authentication error. Please log in again.';
                    return;
                }

                if (selectedFiles.size === 0) {
                    messageDiv.classList.add('error');
                    messageDiv.textContent = 'Please upload at least one property image.';
                    return;
                }

                const formData = new FormData(addPropertyForm); 
                
                
                formData.set('landlord_id', currentUserId); 

                
                let imageIndex = 0;
                selectedFiles.forEach((file, fileId) => {
                    const descriptionInput = imageDescriptionInputsDiv.querySelector(`input[name="image_descriptions[${fileId}]"]`);
                    const description = descriptionInput ? descriptionInput.value : '';

                    formData.append(`property_images[${imageIndex}]`, file);
                    formData.append(`image_descriptions[${imageIndex}]`, description);
                    imageIndex++;
                });

                try {
                    const response = await fetch('backend/add_property.php', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        messageDiv.classList.add('success');
                        messageDiv.textContent = 'Property added successfully!';
                        addPropertyForm.reset(); 
                        selectedFiles.clear(); 
                        imageDescriptionInputsDiv.innerHTML = ''; 
                        propertyImagesInput.value = ''; 
                        setTimeout(() => { window.location.href = 'landlord-dashboard.html'; }, 2000);
                    } else {
                        messageDiv.classList.add('error');
                        messageDiv.textContent = result.message || 'Failed to add property.';
                    }
                } catch (error) {
                    messageDiv.classList.add('error');
                    messageDiv.textContent = 'An error occurred: ' + error.message;
                    console.error('Error:', error);
                }
            });
        });
</script>

    <div class="container form-container">
        <h1 style="color: #8B4513; text-align: center; margin-bottom: 30px;">Add New Property</h1>
        <div id="message" class="message"></div>
        <form id="addPropertyForm">
            <div class="form-group">
                <label for="title">Property Title</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" required></textarea>
            </div>
            <div class="form-group">
                <label for="address">Address</label>
                <input type="text" id="address" name="address" required>
            </div>
            <div class="form-group">
                <label for="city">City</label>
                <input type="text" id="city" name="city" required>
            </div>
            <div class="form-group">
                <label for="state_province">State/Province</label>
                <input type="text" id="state_province" name="state_province">
            </div>
            <div class="form-group">
                <label for="zip_code">Zip Code</label>
                <input type="text" id="zip_code" name="zip_code">
            </div>
            <div class="form-group">
                <label for="num_bedrooms">Number of Bedrooms</label>
                <input type="number" id="num_bedrooms" name="num_bedrooms" min="0">
            </div>
            <div class="form-group">
                <label for="num_bathrooms">Number of Bathrooms</label>
                <input type="number" id="num_bathrooms" name="num_bathrooms" step="0.5" min="0">
            </div>
            <div class="form-group">
                <label for="square_footage">Square Footage</label>
                <input type="number" id="square_footage" name="square_footage" min="0">
            </div>
            <div class="form-group">
                <label for="rent_price">Rent Price</label>
                <input type="number" id="rent_price" name="rent_price" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="currency">Currency</label>
                <select id="currency" name="currency" required>
                    <option value="GHS">GHS</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                </select>
            </div>
            <div class="form-group">
                <label for="property_type">Property Type</label>
                <select id="property_type" name="property_type" required>
                    <option value="apartment">Apartment</option>
                    <option value="house">House</option>
                    <option value="condo">Condo</option>
                    <option value="townhouse">Townhouse</option>
                    <option value="studio">Studio</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="propertyImages">Property Images</label>
                <input type="file" id="propertyImages" name="property_images[]" multiple accept="image/*" required>
            </div>
            <div id="imageDescriptionInputs" style="margin-top: 15px;">
              
            </div>
            
            <button type="submit" class="btn btn-submit">Add Property</button>
        </form>
    </div>

    <footer class="footer">
        <p>&copy; 2025 LeaseLink. All rights reserved.</p>
    </footer>
</body>
</html>
