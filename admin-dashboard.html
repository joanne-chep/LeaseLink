<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>LeaseLink - Admin Dashboard</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/utils.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .dashboard-section {
            margin-bottom: 40px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .dashboard-section h2 {
            color: #8B4513;
            margin-bottom: 20px;
        }
        .summary-cards {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 40px;
        }
        .summary-card {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            text-align: center;
            min-width: 200px;
            flex: 1;
        }
        .summary-card h3 {
            color: #D2691E;
            margin-bottom: 10px;
        }
        .summary-card p {
            font-size: 1.5em;
            font-weight: bold;
            color: #003366;
        }
    </style>
    <script src="js/authGuard.js"></script>
    <script src="js/logout.js"></script>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="logo">LeaseLink</div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="properties.html">Properties</a></li>
                <li><a href="login.html" id="navAuthLink">Login</a></li>
            </ul>
        </nav>
    </header>

    <script>

    function loadAdminStats(adminId) {
        fetch(`backend/get_admin_stats.php?userId=${adminId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.stats) {
                    document.getElementById('totalUsers').textContent = data.stats.total_users;
                    document.getElementById('activeProperties').textContent = data.stats.active_properties;
                    document.getElementById('pendingViewings').textContent = data.stats.pending_viewings;
                    document.getElementById('activeBookings').textContent = data.stats.active_bookings;
                }
            })
            .catch(error => {
                console.error('Error loading stats:', error);
            });
    }

    function loadAllUsers(adminId) {
        fetch(`backend/get_all_users.php?userId=${adminId}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('users-container');
                if (data.success && data.users.length > 0) {
                    let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;"><thead><tr style="background-color: #f5f5f5;"><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">ID</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Username</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Email</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Name</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Type</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Created</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Actions</th></tr></thead><tbody>';
                    data.users.forEach(user => {
                        const createdDate = new Date(user.created_at).toLocaleDateString();
                        const usernameEscaped = (user.username || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const emailEscaped = (user.email || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const firstNameEscaped = (user.first_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const lastNameEscaped = (user.last_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        html += `<tr><td style="padding: 10px; border: 1px solid #ddd;">${user.user_id}</td><td style="padding: 10px; border: 1px solid #ddd;">${user.username}</td><td style="padding: 10px; border: 1px solid #ddd;">${user.email}</td><td style="padding: 10px; border: 1px solid #ddd;">${user.first_name || ''} ${user.last_name || ''}</td><td style="padding: 10px; border: 1px solid #ddd;">${user.user_type}</td><td style="padding: 10px; border: 1px solid #ddd;">${createdDate}</td><td style="padding: 10px; border: 1px solid #ddd;"><button class="btn" onclick="editUser(${user.user_id}, '${usernameEscaped}', '${emailEscaped}', '${user.user_type}', '${firstNameEscaped}', '${lastNameEscaped}', ${adminId})" style="padding: 5px 10px; font-size: 0.9em; margin-right: 5px;">Edit</button><button class="btn btn-secondary" onclick="deleteUser(${user.user_id}, ${adminId})" style="padding: 5px 10px; font-size: 0.9em;">Delete</button></td></tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p>No users found.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading users:', error);
                document.getElementById('users-container').innerHTML = '<p style="color: red;">Error loading users.</p>';
            });
    }

    function loadPendingLandlords(adminId) {
        fetch(`backend/get_pending_landlords.php?userId=${adminId}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('pending-landlords-container');
                if (data.success && data.landlords.length > 0) {
                    let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;"><thead><tr style="background-color: #f5f5f5;"><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">ID</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Name</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Email</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Phone</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Documents</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Created</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Actions</th></tr></thead><tbody>';
                    data.landlords.forEach(landlord => {
                        const createdDate = new Date(landlord.created_at).toLocaleDateString();
                        const hasProfilePic = landlord.profile_picture_url ? `<a href="${landlord.profile_picture_url}" target="_blank">View</a>` : '<span style="color: red;">Missing</span>';
                        const hasIdDoc = landlord.id_document_url ? `<a href="${landlord.id_document_url}" target="_blank">View</a>` : '<span style="color: red;">Missing</span>';
                        const hasOwnershipDoc = landlord.ownership_document_url ? `<a href="${landlord.ownership_document_url}" target="_blank">View</a>` : '<span style="color: red;">Missing</span>';
                        
                        html += `<tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">${landlord.user_id}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${landlord.first_name || ''} ${landlord.last_name || ''}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${landlord.email}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${landlord.phone_number || 'N/A'}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">
                                <small>Profile: ${hasProfilePic}<br>
                                ID: ${hasIdDoc}<br>
                                Ownership: ${hasOwnershipDoc}</small>
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${createdDate}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">
                                <button class="btn" onclick="updateLandlordApproval(${landlord.user_id}, 'approved', ${adminId})" style="padding: 5px 10px; font-size: 0.9em; margin-right: 5px;">Approve</button>
                                <button class="btn btn-secondary" onclick="updateLandlordApproval(${landlord.user_id}, 'rejected', ${adminId})" style="padding: 5px 10px; font-size: 0.9em;">Reject</button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p>No pending landlords found.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading pending landlords:', error);
                document.getElementById('pending-landlords-container').innerHTML = '<p style="color: red;">Error loading pending landlords.</p>';
            });
    }
    
    function updateLandlordApproval(landlordId, status, adminId) {
        const action = status === 'approved' ? 'approve' : 'reject';
        if (!confirm(`Are you sure you want to ${action} this landlord?`)) {
            return;
        }

        const formData = new FormData();
        formData.append('landlord_id', landlordId);
        formData.append('approval_status', status);
        formData.append('admin_id', adminId);

        fetch('backend/update_landlord_approval.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }

    function editUser(userId, username, email, userType, firstName, lastName, adminId) {
        const formHtml = `
            <div id="editUserModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <h2 style="margin-top: 0; color: #8B4513;">Edit User</h2>
                    <form id="editUserForm" onsubmit="submitUserEdit(event, ${userId}, ${adminId})">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Username:</label>
                            <input type="text" name="username" value="${username.replace(/"/g, '&quot;')}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                            <input type="email" name="email" value="${email.replace(/"/g, '&quot;')}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">First Name:</label>
                            <input type="text" name="first_name" value="${(firstName || '').replace(/"/g, '&quot;')}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Last Name:</label>
                            <input type="text" name="last_name" value="${(lastName || '').replace(/"/g, '&quot;')}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">User Type:</label>
                            <select name="user_type" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="client" ${userType === 'client' ? 'selected' : ''}>Client</option>
                                <option value="landlord" ${userType === 'landlord' ? 'selected' : ''}>Landlord</option>
                                <option value="admin" ${userType === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn" style="flex: 1;">Save</button>
                            <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()" style="flex: 1;">Cancel</button>
                        </div>
                    </form>
                    <div id="editUserMessage" style="margin-top: 15px; display: none;"></div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', formHtml);
    }

    function submitUserEdit(event, userId, adminId) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        formData.append('user_id', userId);
        formData.append('admin_id', adminId);
        const messageDiv = document.getElementById('editUserMessage');
        
        fetch('backend/update_user.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageDiv.style.display = 'block';
                messageDiv.style.color = 'green';
                messageDiv.textContent = data.message;
                setTimeout(() => {
                    closeEditUserModal();
                    location.reload();
                }, 1500);
            } else {
                messageDiv.style.display = 'block';
                messageDiv.style.color = 'red';
                messageDiv.textContent = data.message;
            }
        })
        .catch(error => {
            messageDiv.style.display = 'block';
            messageDiv.style.color = 'red';
            messageDiv.textContent = 'An error occurred. Please try again.';
            console.error('Error:', error);
        });
    }

    function closeEditUserModal() {
        const modal = document.getElementById('editUserModal');
        if (modal) {
            modal.remove();
        }
    }

    function deleteUser(userId, adminId) {
        if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            return;
        }

        const formData = new FormData();
        formData.append('user_id', userId);
        formData.append('admin_id', adminId);

        fetch('backend/delete_user.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }


    // --- Main Document Ready Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        const navAuthLink = document.getElementById('navAuthLink');
        const navLinksUl = navAuthLink ? navAuthLink.parentNode.parentNode : null;
        const loginListItem = navAuthLink ? navAuthLink.parentNode : null;

        if (!navAuthLink || !navLinksUl || !loginListItem) {
            return;
        }

        fetch('backend/get_session_info.php')
            .then(response => response.json())
            .then(data => {
                const { userName, userType, isLoggedIn, userId } = data;
                const adminId = userId;

                if (isLoggedIn) {
                    const dashboardLink = document.createElement('a');
                    dashboardLink.textContent = `Welcome, ${userName}`;
                    let dashboardUrl = (userType === 'client') ? 'client-dashboard.html' : 
                                       (userType === 'landlord') ? 'landlord-dashboard.html' : 
                                       (userType === 'admin') ? 'admin-dashboard.html' : 'index.html';
                    dashboardLink.href = dashboardUrl;
                    const dashboardListItem = document.createElement('li');
                    dashboardListItem.appendChild(dashboardLink);

                    const logoutLink = document.createElement('a');
                    logoutLink.href = '#';
                    logoutLink.textContent = 'Logout';
                    logoutLink.onclick = (e) => {
                        e.preventDefault();
                        performLogout();
                    };
                    const logoutListItem = document.createElement('li');
                    logoutListItem.appendChild(logoutLink);

                    navLinksUl.replaceChild(dashboardListItem, loginListItem);
                    navLinksUl.appendChild(logoutListItem);

                    if (userType === 'landlord' || userType === 'admin') {
                        navLinksUl.querySelectorAll('a').forEach(link => {
                            if (link.getAttribute('href') === 'index.html' || link.getAttribute('href') === 'properties.html') {
                                if (link.parentElement.tagName === 'LI') { link.parentElement.style.display = 'none'; }
                            }
                        });
                    }
                    
                    if (document.getElementById('welcomeMessage')) {
                        document.getElementById('welcomeMessage').textContent = `Welcome, ${userName}!`;
                    }

                    if (adminId) {
                        loadAdminStats(adminId);
                        loadAllUsers(adminId);
                        loadPendingLandlords(adminId);
                    }

                } else {
                     window.location.href = 'login.html';
                }
            })
            .catch(error => {
                console.error('Error updating navigation:', error);
            });
    });
</script>

    <div class="container dashboard-container">
        <div class="dashboard-header">
            <h1 style="color: #8B4513;">Admin Dashboard</h1>
            <p id="welcomeMessage" style="font-size: 1.2em; color: #555;"></p>
        </div>

        <div class="summary-cards">
            <div class="summary-card">
                <h3>Total Users</h3>
                <p id="totalUsers">...</p>
            </div>
            <div class="summary-card">
                <h3>Active Properties</h3>
                <p id="activeProperties">...</p>
            </div>
            <div class="summary-card">
                <h3>Pending Viewings</h3>
                <p id="pendingViewings">...</p>
            </div>
            <div class="summary-card">
                <h3>Active Bookings</h3>
                <p id="activeBookings">...</p>
            </div>
        </div>

        <div class="dashboard-section">
            <h2>User Management</h2>
            <p>List of all users (clients, landlords, admins) with options to edit/delete.</p>
            <div id="users-container">
                <p>Loading users...</p>
            </div>
        </div>

        <div class="dashboard-section">
            <h2>Landlord Approval</h2>
            <p>Review and approve/reject landlord applications. Landlords must upload profile picture, ID document, and ownership document.</p>
            <div id="pending-landlords-container">
                <p>Loading pending landlords...</p>
            </div>
        </div>

        <div class="dashboard-section">
            <h2>System Logs & Analytics</h2>
            <p>Access to system logs, usage statistics, and other administrative tools.</p>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 LeaseLink. All rights reserved.</p>
    </footer>
</body>
</html>
