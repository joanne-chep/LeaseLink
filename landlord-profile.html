<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeaseLink - Complete Your Profile</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/utils.css">
    <style>
        .form-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
        }
        .file-upload-preview {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .file-upload-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 5px;
        }
        .file-upload-preview a {
            display: inline-block;
            margin-top: 10px;
            color: #8B4513;
            text-decoration: none;
        }
        .approval-status {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .approval-status.pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }
        .approval-status.approved {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }
        .approval-status.rejected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #dc3545;
        }
        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
    <script src="js/authGuard.js"></script>
    <script src="js/logout.js"></script>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="logo">LeaseLink</div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="properties.html">Properties</a></li>
                <li><a href="login.html" id="navAuthLink">Login</a></li>
            </ul>
        </nav>
    </header>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const navAuthLink = document.getElementById('navAuthLink');
        const navLinksUl = navAuthLink ? navAuthLink.parentNode.parentNode : null;
        const loginListItem = navAuthLink ? navAuthLink.parentNode : null;

        if (!navAuthLink || !navLinksUl || !loginListItem) {
            return;
        }

        fetch('backend/get_session_info.php')
            .then(response => response.json())
            .then(data => {
                const { userName, userType, isLoggedIn, userId } = data;

                if (isLoggedIn && userType === 'landlord') {
                    const dashboardLink = document.createElement('a');
                    dashboardLink.textContent = `Welcome, ${userName}`;
                    dashboardLink.href = 'landlord-dashboard.html';
                    const dashboardListItem = document.createElement('li');
                    dashboardListItem.appendChild(dashboardLink);

                    const logoutLink = document.createElement('a');
                    logoutLink.href = '#';
                    logoutLink.textContent = 'Logout';
                    logoutLink.onclick = (e) => {
                        e.preventDefault();
                        performLogout();
                    };
                    const logoutListItem = document.createElement('li');
                    logoutListItem.appendChild(logoutLink);

                    navLinksUl.replaceChild(dashboardListItem, loginListItem);
                    navLinksUl.appendChild(logoutListItem);

                    
                    loadProfile(userId);
                } else if (!isLoggedIn || userType !== 'landlord') {
                    window.location.href = 'login.html';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                window.location.href = 'login.html';
            });
    });

    let currentUserId = null;
    let uploadedFiles = {
        profile_picture: null,
        id_document: null,
        ownership_document: null
    };

    function loadProfile(userId) {
        currentUserId = userId;
        fetch(`backend/get_landlord_profile.php?userId=${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.profile) {
                    const profile = data.profile;
                    
                    // Populate form fields
                    document.getElementById('firstName').value = profile.first_name || '';
                    document.getElementById('lastName').value = profile.last_name || '';
                    document.getElementById('email').value = profile.email || '';
                    document.getElementById('phoneNumber').value = profile.phone_number || '';

                    // Display approval status
                    const statusDiv = document.getElementById('approvalStatus');
                    statusDiv.className = 'approval-status ' + profile.approval_status;
                    const statusText = {
                        'pending': 'Your profile is pending admin approval. Please complete all required documents.',
                        'approved': 'Your profile has been approved! You can now list properties.',
                        'rejected': 'Your profile was rejected. Please review and resubmit your documents.'
                    };
                    statusDiv.textContent = statusText[profile.approval_status] || 'Unknown status';

                    // Show existing files if uploaded
                    if (profile.profile_picture_url) {
                        displayFilePreview('profile_picture', profile.profile_picture_url, profile.profile_picture_url);
                    }
                    if (profile.id_document_url) {
                        displayFilePreview('id_document', profile.id_document_url, profile.id_document_url);
                    }
                    if (profile.ownership_document_url) {
                        displayFilePreview('ownership_document', profile.ownership_document_url, profile.ownership_document_url);
                    }
                }
            })
            .catch(error => {
                console.error('Error loading profile:', error);
            });
    }

    function handleFileSelect(fileType, event) {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('file_type', fileType);

        // Show uploading message
        const previewDiv = document.getElementById(fileType + 'Preview');
        previewDiv.innerHTML = '<p>Uploading...</p>';

        fetch('backend/upload_file.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploadedFiles[fileType] = data.file_url;
                displayFilePreview(fileType, data.file_url, file.name);
            } else {
                previewDiv.innerHTML = '<p style="color: red;">Upload failed: ' + data.message + '</p>';
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            previewDiv.innerHTML = '<p style="color: red;">Upload failed. Please try again.</p>';
        });
    }

    function displayFilePreview(fileType, fileUrl, fileName) {
        const previewDiv = document.getElementById(fileType + 'Preview');
        const isImage = /\.(jpg|jpeg|png|gif)$/i.test(fileUrl);
        
        if (isImage) {
            previewDiv.innerHTML = `
                <img src="${fileUrl}" alt="${fileName}" />
                <br><a href="${fileUrl}" target="_blank">View ${fileName}</a>
            `;
        } else {
            previewDiv.innerHTML = `
                <p>File uploaded: ${fileName}</p>
                <a href="${fileUrl}" target="_blank">View Document</a>
            `;
        }
    }

    function saveProfile(event) {
        event.preventDefault();

        if (!uploadedFiles.profile_picture || !uploadedFiles.id_document || !uploadedFiles.ownership_document) {
            showMessage('Please upload all required documents: Profile Picture, ID Document, and Ownership Document.', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('landlord_id', currentUserId);
        formData.append('profile_picture_url', uploadedFiles.profile_picture);
        formData.append('id_document_url', uploadedFiles.id_document);
        formData.append('ownership_document_url', uploadedFiles.ownership_document);
        formData.append('phone_number', document.getElementById('phoneNumber').value);

        fetch('backend/update_landlord_profile.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Profile updated successfully! Your documents are now pending admin approval.', 'success');
                setTimeout(() => {
                    window.location.href = 'landlord-dashboard.html';
                }, 2000);
            } else {
                showMessage('Error: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred. Please try again.', 'error');
        });
    }

    function showMessage(text, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.innerHTML = `<div class="${type}">${text}</div>`;
        setTimeout(() => {
            messageDiv.innerHTML = '';
        }, 5000);
    }
    </script>

    <div class="container form-container">
        <h1 style="text-align: center; color: #8B4513;">Complete Your Landlord Profile</h1>
        <div id="approvalStatus" class="approval-status pending"></div>

        <form onsubmit="saveProfile(event)">
            <div class="form-group">
                <label>First Name:</label>
                <input type="text" id="firstName" readonly>
            </div>

            <div class="form-group">
                <label>Last Name:</label>
                <input type="text" id="lastName" readonly>
            </div>

            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="email" readonly>
            </div>

            <div class="form-group">
                <label>Phone Number:</label>
                <input type="tel" id="phoneNumber" placeholder="Enter your phone number">
            </div>

            <div class="form-group">
                <label>Profile Picture <span style="color: red;">*</span>:</label>
                <input type="file" accept="image/*" onchange="handleFileSelect('profile_picture', event)" required>
                <div id="profile_picturePreview" class="file-upload-preview"></div>
            </div>

            <div class="form-group">
                <label>Identification Document (ID/Passport) <span style="color: red;">*</span>:</label>
                <input type="file" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileSelect('id_document', event)" required>
                <div id="id_documentPreview" class="file-upload-preview"></div>
            </div>

            <div class="form-group">
                <label>Property Ownership Document <span style="color: red;">*</span>:</label>
                <input type="file" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileSelect('ownership_document', event)" required>
                <div id="ownership_documentPreview" class="file-upload-preview"></div>
            </div>

            <button type="submit" class="btn" style="width: 100%; padding: 15px; font-size: 1.1em;">Save Profile</button>
        </form>

        <div id="message"></div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 LeaseLink. All rights reserved.</p>
    </footer>
</body>
</html>

